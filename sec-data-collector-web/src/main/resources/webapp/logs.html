<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEC 13F 系统日志</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .log-container {
            height: 600px;
            overflow-y: auto;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-level-INFO { color: #4CAF50; }
        .log-level-WARN { color: #FF9800; }
        .log-level-ERROR { color: #f44336; }
        .log-level-DEBUG { color: #2196F3; }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #667eea;
            color: white;
            font-size: 14px;
        }
        button:hover { background: #5a67d8; }
        
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filter-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: auto;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .stats {
            padding: 10px 20px;
            background: #f8f9fa;
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .download-logs {
            background: #28a745;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SEC 13F Parser 系统日志</h1>
            <p>实时监控系统运行状态和爬取进度</p>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <label>日志级别:</label>
                <select id="logLevel">
                    <option value="">全部</option>
                    <option value="INFO">INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                    <option value="DEBUG">DEBUG</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>关键词:</label>
                <input type="text" id="searchKeyword" placeholder="搜索日志内容">
            </div>
            
            <button onclick="clearLogs()">清空日志</button>
            <button onclick="refreshLogs()">刷新</button>
            <button onclick="toggleAutoRefresh()" id="autoRefreshBtn">开启自动刷新</button>
            
            <a href="#" onclick="downloadLogs()" class="download-logs">下载日志文件</a>
            
            <div class="status connected" id="connectionStatus">
                ● 已连接
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <span>📊 总日志数:</span>
                <span id="totalLogs">0</span>
            </div>
            <div class="stat-item">
                <span>❌ 错误数:</span>
                <span id="errorCount">0</span>
            </div>
            <div class="stat-item">
                <span>⚠️ 警告数:</span>
                <span id="warnCount">0</span>
            </div>
            <div class="stat-item">
                <span>🕒 最后更新:</span>
                <span id="lastUpdate">-</span>
            </div>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="log-entry">等待日志数据...</div>
        </div>
    </div>

    <script>
        class LogViewer {
            constructor() {
                this.logs = [];
                this.autoRefresh = false;
                this.refreshInterval = null;
                this.maxLogs = 1000;
                
                this.init();
            }
            
            init() {
                document.getElementById('logLevel').addEventListener('change', () => this.filterLogs());
                document.getElementById('searchKeyword').addEventListener('input', () => this.filterLogs());
                
                this.loadInitialLogs();
                this.startLogSimulation(); // 模拟日志数据
            }
            
            loadInitialLogs() {
                // 模拟初始日志数据
                this.addLog('INFO', 'System started successfully');
                this.addLog('INFO', 'Database initialized');
                this.addLog('INFO', 'Web server started on port 8080');
                this.addLog('DEBUG', 'SEC scraper initialized');
                this.updateDisplay();
            }
            
            startLogSimulation() {
                // 模拟实时日志
                setInterval(() => {
                    if (Math.random() < 0.3) {
                        const levels = ['INFO', 'WARN', 'ERROR', 'DEBUG'];
                        const messages = [
                            'SEC_REQUEST - URL: https://data.sec.gov/submissions/CIK0001067983.json, Status: 200',
                            'SCRAPING_STARTED - CIK: 0001067983, Company: Berkshire Hathaway Inc',
                            'DATA_VALIDATION - Type: Filing, Message: Validation passed',
                            'API_REQUEST - Endpoint: /api/analysis/overview, Params: cik=0001067983',
                            'SCRAPING_COMPLETED - CIK: 0001067983, Saved: 1 filings',
                            'Database connection established',
                            'Processing 13F XML file: primary_doc.xml'
                        ];
                        
                        const level = levels[Math.floor(Math.random() * levels.length)];
                        const message = messages[Math.floor(Math.random() * messages.length)];
                        
                        this.addLog(level, message);
                        this.updateDisplay();
                    }
                }, 2000);
            }
            
            addLog(level, message) {
                const timestamp = new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    fractionalSecondDigits: 3
                });
                
                const logEntry = {
                    timestamp,
                    level,
                    message,
                    id: Date.now() + Math.random()
                };
                
                this.logs.unshift(logEntry);
                
                // 限制日志数量
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(0, this.maxLogs);
                }
            }
            
            filterLogs() {
                const levelFilter = document.getElementById('logLevel').value;
                const keywordFilter = document.getElementById('searchKeyword').value.toLowerCase();
                
                const filteredLogs = this.logs.filter(log => {
                    const levelMatch = !levelFilter || log.level === levelFilter;
                    const keywordMatch = !keywordFilter || 
                        log.message.toLowerCase().includes(keywordFilter) ||
                        log.level.toLowerCase().includes(keywordFilter);
                    
                    return levelMatch && keywordMatch;
                });
                
                this.displayLogs(filteredLogs);
            }
            
            updateDisplay() {
                this.filterLogs();
                this.updateStats();
            }
            
            displayLogs(logs) {
                const container = document.getElementById('logContainer');
                
                if (logs.length === 0) {
                    container.innerHTML = '<div class="log-entry">没有匹配的日志</div>';
                    return;
                }
                
                const html = logs.map(log => 
                    `<div class="log-entry log-level-${log.level}">
                        [${log.timestamp}] ${log.level} - ${this.escapeHtml(log.message)}
                    </div>`
                ).join('');
                
                container.innerHTML = html;
                
                // 自动滚动到顶部 (最新日志)
                container.scrollTop = 0;
            }
            
            updateStats() {
                const totalLogs = this.logs.length;
                const errorCount = this.logs.filter(log => log.level === 'ERROR').length;
                const warnCount = this.logs.filter(log => log.level === 'WARN').length;
                const lastUpdate = new Date().toLocaleTimeString('zh-CN');
                
                document.getElementById('totalLogs').textContent = totalLogs;
                document.getElementById('errorCount').textContent = errorCount;
                document.getElementById('warnCount').textContent = warnCount;
                document.getElementById('lastUpdate').textContent = lastUpdate;
            }
            
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
            
            clearLogs() {
                this.logs = [];
                this.updateDisplay();
            }
            
            refreshLogs() {
                // 在真实环境中，这里会调用API获取最新日志
                this.updateDisplay();
            }
            
            toggleAutoRefresh() {
                this.autoRefresh = !this.autoRefresh;
                const btn = document.getElementById('autoRefreshBtn');
                
                if (this.autoRefresh) {
                    btn.textContent = '停止自动刷新';
                    this.refreshInterval = setInterval(() => this.refreshLogs(), 5000);
                } else {
                    btn.textContent = '开启自动刷新';
                    if (this.refreshInterval) {
                        clearInterval(this.refreshInterval);
                        this.refreshInterval = null;
                    }
                }
            }
        }
        
        // 全局函数
        function clearLogs() {
            logViewer.clearLogs();
        }
        
        function refreshLogs() {
            logViewer.refreshLogs();
        }
        
        function toggleAutoRefresh() {
            logViewer.toggleAutoRefresh();
        }
        
        function downloadLogs() {
            // 模拟下载日志文件
            const logs = logViewer.logs.map(log => 
                `[${log.timestamp}] ${log.level} - ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sec13f-logs-${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // 初始化日志查看器
        let logViewer;
        document.addEventListener('DOMContentLoaded', () => {
            logViewer = new LogViewer();
        });
    </script>
</body>
</html>